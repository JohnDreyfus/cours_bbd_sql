# TP : Mise en place d'une réplication PostgreSQL avec Docker

## Étape 1 : Arrêter et nettoyer tout

```bash
docker-compose down -v
docker volume rm /* les volumes du projet */
```


---

## Étape 2 : Créer le nouveau docker-compose.yml

Remplacez tout le contenu de votre fichier `docker-compose.yml` par :

```yaml
services:
  postgres-primary:
    image: postgres:17
    container_name: web-postgres-primary
    restart: unless-stopped
    environment:
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: password
      POSTGRES_DB: cours
      TZ: Europe/Paris
    ports:
      - "5432:5432"
    volumes:
      - pgdata-primary:/var/lib/postgresql/data
    command: >
      postgres
      -c wal_level=replica
      -c max_wal_senders=10
      -c max_replication_slots=10
      -c hot_standby=on
    networks:
      - dbnet

  postgres-replica:
    image: postgres:17
    container_name: web-postgres-replica
    restart: unless-stopped
    environment:
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: password
      TZ: Europe/Paris
    ports:
      - "5433:5432"
    volumes:
      - pgdata-replica:/var/lib/postgresql/data
    networks:
      - dbnet

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: web-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: adminpass
      TZ: Europe/Paris
    ports:
      - "5050:80"
    volumes:
      - pgadmin:/var/lib/pgadmin
    networks:
      - dbnet

networks:
  dbnet:

volumes:
  pgdata-primary:
  pgdata-replica:
  pgadmin:
```

---

## Étape 3 : Démarrer uniquement le serveur primary

```bash
docker-compose up -d postgres-primary
```
**Attendre 15 secondes que le serveur postgres a bien démarré**

---

## Étape 4 : Créer l'utilisateur de réplication sur le serveur primary

```bash
docker exec -it web-postgres-primary psql -U dev -d cours -c "CREATE ROLE replicator WITH REPLICATION LOGIN PASSWORD 'replicator_password';"
```

---

## Étape 5 : Configurer l'accès réseau

```bash
docker exec -it web-postgres-primary bash -c "echo 'host replication replicator all scram-sha-256' >> /var/lib/postgresql/data/pg_hba.conf"
```

```bash
docker exec -it web-postgres-primary psql -U dev -d cours -c "SELECT pg_reload_conf();"
```

Résultat attendu : cela signifie que le serveur maitre est configuré

```
pg_reload_conf
------------
t
```
---

## Étape 6 : Créer la copie pour le replica

```bash
docker run --rm \
  --network cours_dbnet \
  -e PGPASSWORD=replicator_password \
  -v cours_pgdata-replica:/var/lib/postgresql/data \
  postgres:17 \
  pg_basebackup -h postgres-primary -U replicator -D /var/lib/postgresql/data -P -R -X stream -c fast
```

---

## Étape 7 : Démarrer le replica

```bash
docker-compose up -d postgres-replica
```
**Attendre 15 secondes que le serveur postgres a bien démarré**


---

## Étape 8 : Vérifier que ça fonctionne

```bash
docker exec -it web-postgres-primary psql -U dev -d cours -c "SELECT client_addr, state FROM pg_stat_replication;"
```

Résultat attendu : une ligne avec `state | streaming`
Cela veut dire que la connexion entre le serveur maitre et le serveur de replication est ok

---

## Étape 9 : Démarrer le serveur pgadmin

```bash
docker compose up -d pgadmin
```

Attendez 10 secondes que le serveur démarre complètement.

Vérifiez que le serveur fonctionne :
- Sur PgAdmin, connectez-vous a la base postgres-primary

![image 1](image1.png)

![image 2](image2.png)


## Étape 10 : Répéter l'étape 9 pour postgres-replica sur pgAdmin

- vous devez voir les deux base dans votre PgAdmin

## Étape 11 : Test réplication

- Récupérer le sql qui est dans le cours sur github et lancer le sur postgres-primary.
- refresh les schema sur postgres-primary pour voir que ça a bien fonctionné
- refresh les schema sur postgres-replica pour voir la réplication
- fini :-) 
